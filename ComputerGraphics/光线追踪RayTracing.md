# 光线追踪RayTracing

### 为什么要用光线追踪

光栅化的局限在于：

1. 对全局效果的支持不够好，例如：

> 1. 软阴影
> 2. glossy反射（毛玻璃效果的反射）
> 3. 间接光照（光线弹射多次抵达人眼）

2. 渲染速度快，但质量低


光线追踪的优势：

1. 质量高，速度慢
2. 符合物理规律，更真实的渲染结果

### 光线追踪的原理(Recursive Ray Tracing)

1. 从观测相机(人眼,点)出发，向投影的近平面中某一像素发射光线
2. 当光线碰撞到三角形
3. 判断三角形是否可以被点光源看到，看不到则在阴影里
4. 对光线进行反射
5. 对次级反射光线碰到的三角形，也进行阴影判断
6. 将**所有光线碰撞的点**的着色，加到像素上


<img width="562" height="360" alt="image" src="https://github.com/user-attachments/assets/357a6601-226f-40f4-aa5e-8873412a5f72" />



问题一：光线追踪中的着色，是逐顶点着色吗？也就是说光线的能量是整个三角形面统一的吗

问题二：光线从相机视角出发，能量衰减的计算是不是反了？应该从点光源出发时的能量是完整的，抵达相机时衰减了


### 射线与平面求交点

光线公式：r(t) = **o** + t**d**, **o**表示起点，**d**表示方向，t表示时间，t≥0

思路：
1. 光线与三角形所在平面求交点
2. 判断交点是否在三角形内部

> 有算法可以将两步合成一步，和重心坐标有关

> 如何求交点？
> 将光线的表达式带入平面中：
> 如何有解，则有交点
> 无解，则无交点

### 加速判断

引入AABB(Axis Aligned Bounding Box)，包围盒的三个对面分别与xy,yz,zx平面平行

为什么引入AABB(轴对⻬包围盒)？

1. 当光线与包围盒有交点时，才能可以与其中的网格产生碰撞
2. 光线与轴对齐的平面求交点可以加速求解

如何加速？
1. 假设光线与x轴垂直的平面求交点
2. 可以转化为求：平面上任意一点的x值，与起点o的x值作差，作为距离，方向向量d上的x轴分量作为速度
3. 求最后的时间t，则可以求出交点
4. 将计算量减小了

### 如何判断光线与轴对齐包围盒有交点？

1. 与三个对面进行交点的计算，对于较小的t值，记为tmin,较大的值记为tmax
2. 对于三个对面中的tmin，可以计算出光线进入包围盒的时间T_exit，即三个tmin中的最大值 max{tmin}
3. 对于三个对面中的tmax，可以计算出光线离开包围盒的时间T_enter，即三个tmax中的最小值 min{tmax}
4. 当T_enter < T_exit时，表示光线在包围盒内部停留
5. 考虑T_exit为负值的情况，表示光线在包围盒背面（则无交点）
6. 当T_enter为负值时，光线在包围盒内部，所以最终条件：
7. T_enter < T_exit && T_exit >= 0




