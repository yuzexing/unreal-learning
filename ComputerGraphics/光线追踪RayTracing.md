# 光线追踪RayTracing

### 为什么要用光线追踪

光栅化的局限在于：

1. 对全局效果的支持不够好，例如：

> 1. 软阴影
> 2. glossy反射（毛玻璃效果的反射）
> 3. 间接光照（光线弹射多次抵达人眼）

2. 渲染速度快，但质量低


光线追踪的优势：

1. 质量高，速度慢
2. 符合物理规律，更真实的渲染结果

### 光线追踪的原理(Recursive Ray Tracing)

1. 从观测相机(人眼,点)出发，向投影的成像平面中某一像素发射光线
2. 当光线碰撞第一个顶点时
3. 判断点是否可以被点光源看到，看不到则在阴影里
4. 如果是镜面/折射面，则对光线进行镜面反射或者折射；
5. 如果是散射面即漫反射，则不继续进行反射；
6. 对次级反射光线碰到的点，也进行阴影判断
7. 将**所有光线碰撞的点**的光照计算值，加到像素上


<img width="562" height="360" alt="image" src="https://github.com/user-attachments/assets/357a6601-226f-40f4-aa5e-8873412a5f72" />



问题一：光线追踪中的着色，是逐顶点着色吗？也就是说光线的能量是整个三角形面统一的吗

问题二：光线从相机视角出发，能量衰减的计算是不是反了？应该从点光源出发时的能量是完整的，抵达相机时衰减了


### 射线与平面求交点

光线公式：r(t) = **o** + t**d**, **o**表示起点，**d**表示方向，t表示时间，t≥0

思路：
1. 光线与三角形所在平面求交点
2. 判断交点是否在三角形内部

> 有算法可以将两步合成一步，和重心坐标有关
> 也有面积法和叉乘法

> 如何求交点？
> 将光线的表达式带入平面中：
> 如何有解，则有交点
> 无解，则无交点

### 加速判断

引入AABB(Axis Aligned Bounding Box)，包围盒的三个对面分别与xy,yz,zx平面平行

为什么引入AABB(轴对⻬包围盒)？

1. 当光线与包围盒有交点时，才能可以与其中的网格产生碰撞
2. 光线与轴对齐的平面求交点可以加速求解

如何加速？
1. 假设光线与x轴垂直的平面求交点
2. 可以转化为求：平面上任意一点的x值，与起点o的x值作差，作为距离，方向向量d上的x轴分量作为速度
3. 求最后的时间t，则可以求出交点
4. 将计算量减小了

### 如何判断光线与轴对齐包围盒有交点？

1. 与三个对面进行交点的计算，对于较小的t值，记为tmin,较大的值记为tmax
2. 对于三个对面中的tmin，可以计算出光线进入包围盒的时间T_exit，即三个tmin中的最大值 max{tmin}
3. 对于三个对面中的tmax，可以计算出光线离开包围盒的时间T_enter，即三个tmax中的最小值 min{tmax}
4. 当T_enter < T_exit时，表示光线在包围盒内部停留
5. 考虑T_exit为负值的情况，表示光线在包围盒背面（则无交点）
6. 当T_enter为负值时，光线在包围盒内部，所以最终条件：
7. T_enter < T_exit && T_exit >= 0


### 与场景中包围盒加速判断方法

总体分为两类：空间划分和对象划分

都属于场景的预处理

空间划分：
1. 均匀划分(网格划分)
2. 八叉树
3. KD树

对象划分：
1. BVH (Bounding Volume Hierarchy)

### 均匀划分

1. 寻找空间中所有物体的包围盒
2. 将包围盒等分为若干个相等大小的网格
3. 每个网格存储网格内部或相交的物体
4. 光线射出，判断相交的网格
5. 对相交的网格中的物体进行交点检测

问题一：网格如何判断物体在内部或者相交？
> 对于物体的每一个顶点，依次判断是否在盒子内部

问题二：光线射出如何快速判断出需要计算交点的网格？
> 假设光线向右上方射出，在计算出第一个与光线相交的网格后，下一个相交的网格，必定在当前格子的上方或者右方

<img width="390" height="262" alt="image" src="https://github.com/user-attachments/assets/2ff9b5b6-7158-4df3-afab-d69d7e968418" />

需要合适的网格划分数量，常见的是27*object数量

优势：
1. 当物体多且在空间中分布均匀时，效率较高

劣势：
1. 不适用于物体少，空间大的场景

### 八叉树

<img width="150" height="231" alt="image" src="https://github.com/user-attachments/assets/e09e6c40-f797-4e89-863a-8d79ca56cfaa" />

1. 递归的将空间等分为8份盒子
2. 先对盒子做交点检测
3. 再对其中的物体做交点检测

缺点；
1. 节点数量多，占用空间大
2. 空间划分不灵活

### KD树

1. 按xy,yz,zx平面轮流划分空间
2. 划分位置灵活
3. 仅在叶子节点存储物体指针

<img width="397" height="244" alt="image" src="https://github.com/user-attachments/assets/ba45727c-2f5b-4fda-a26c-0c18cec3f23d" />

存在的问题：
1. 物体可能跨多个盒子空间，需要被多次检测
2. 物体与盒子的相交判定难计算


### BVH(Bounding Volume Hierarchy)

较为主流


1. 将网格分为两个部分
2. 对两个部分求包围盒
3. 重复上述过程(可以在分部分时，保持按KD树那种顺序，保持划分的均匀)

优势：
1. 计算简单
2. 每个三角形只会在一个包围盒中

缺点：
1. 包围盒可能存在相交
2. 如果网格划分方法做的不好，可能导致包围盒完全重叠

划分方法：
1. 总是划分网格中最长的轴
2. 从中位数个三角形开始划分

划分终止条件：到一定三角形数量停止

### BVH图示：

算法：递归的与包围盒进行判断，直到抵达叶子节点

<img width="424" height="218" alt="image" src="https://github.com/user-attachments/assets/f3b44e20-ed30-4a0b-9ef3-cc77bb607d10" />

<img width="428" height="292" alt="image" src="https://github.com/user-attachments/assets/1c5afcbd-ba97-445e-85bd-1945d627d4f7" />

