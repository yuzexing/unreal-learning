# C++线程、进程和协程

进程和线程的关系：

进程是操作系统资源分配的单元，线程是资源调度的单元，一个进程中可以包含多个线程

线程和协程的关系：

一个线程可以包含多个协程

协程是什么？

协程是协作式用户态线程，可以理解为是一个可以被挂起并继续执行的函数

线程和协程的对比：
1. 线程基本上是内核态线程，协程是用户态线程
2. 线程切换需要进入内核态，协程不需要陷入内核态，执行效率更高
3. 协程不需要锁的机制，但是需要给资源标记使用状态


协程的实现方式
1. 有栈协程
2. 无栈协程

### 有栈协程

有栈协程是每个协程有自己独立的函数调用栈，在协程切换时，保存旧协程上下文，然后加载新协程上下文即可。


### 无栈协程

无栈协程，共用一个函数调用栈，可以通过状态机管理函数的运行状态，实现使函数从上次挂起的地方继续运行

### 协程调度器

1. 维护一个队列，在协程挂起后，由调度器决定下一个执行的协程
2. 维护当前运行的协程id

有栈协程：

切换协程时，由旧协程保存自己的上下文，协程调度器恢复新协程的上下文

上下文包括各种寄存器：栈顶指针，栈底指针，PC，通用寄存器等


无栈协程：

维护协程的队列，协程让出CPU使用权后，如果没有执行完毕，加入执行队列队尾

[参考1](https://zhuanlan.zhihu.com/p/484820117)|
[参考2](https://blog.csdn.net/qq_29426201/article/details/147415324)|
[参考3](https://blog.csdn.net/weixin_43925427/article/details/144563825)

### 异步编程中的同步问题

1. 死锁
2. 地狱回调
3. 任务饥饿
4. 读取旧数据

解决办法：
1. 银行家算法、资源顺序请求
2. 回调改为链式结构、或者使用同步的语法写异步任务
3. 公平锁
4. 参考操作系统的写后读策略(写优先)

读取旧数据怎么解决
在操作系统中读取cahce时：也有更新cahce的策略
1. 写回策略（优先更新cahce，延迟写回主存）
2. 写直达策略（cache和主存一起更新）


